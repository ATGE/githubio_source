---
title: "OS Reload, OS Reload, OS Reload..."
description: "<p>Need to OS Reload many servers you say!?!</p>\n<p>Do you have a large number of servers whom could use fresh start? A"
date: "2012-06-06"
author: "phil"
tags:
    - "blog"
---

<p>Need to OS Reload many servers you say!?!</p>
<p>Do you have a large number of servers whom could use fresh start? A 1/2 dozen boxes which can now be re-purposed? Maybe want to upgrade to the latest version of Debian and just couldn't be bothered with apt?</p>
<p>What ever the series of events which have led to this moment, you now find yourself in need of a way to submit a seemingly limitless number of OS Reloads and the threat of carpel tunnel makes you weary of accomplishing this task the old(or would that be new) <a href="http://knowledgelayer.softlayer.com/questions/218/OS+Reloads">fashioned way</a>. </p>
<p><strong>Difficulty bonus:</strong> <em>providing primary IP addresses to identify servers, have all servers provisioned with the same operating system.</em></p>
<p>Let us start by getting the usual out of the way...<br />
API Library: Check<br />
API User: Check<br />
API Key: Check<br />
API Service: SoftLayer_Hardware_Server</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;"><?php</span>
<span style="color: #b1b100;">require_once</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'SoftLayer/SoapClient.class.php'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009933; font-style: italic;">/**
 * Set your SoftLayer API username and key.
 */</span>
<span style="color: #000088;">$apiUsername</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">''</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$apiKey</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">''</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000088;">$hardwareClient</span> <span style="color: #339933;">=</span> SoftLayer_SoapClient<span style="color: #339933;">::</span><span style="color: #004000;">getClient</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'SoftLayer_Hardware_Server'</span><span style="color: #339933;">,</span> <span style="color: #000000; font-weight: bold;">NULL</span><span style="color: #339933;">,</span> <span style="color: #000088;">$apiUsername</span><span style="color: #339933;">,</span> <span style="color: #000088;">$apiKey</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div>
<p>Add in a pinch of IP addresses, set aside some space to store  information about our servers and define what OS we want.</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span style="color: #000088;">$ipsToReload</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'1.1.1.1'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'2.2.2.2'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'3.3.3.3'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$operatingSystem</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'CentOS 6.0 - Minimal Install (32 bit)'</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$serversToReload</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div>
<p>When an OS Reload is submitted, by default it will use the pre-existing operating system. If we wish to change that operating system during the reload, we need to submit the itemPrice associated with the operating system. Each package has unique IDs for each item, so it is necessary that our script is not specific to any one package.</p>
<p>This object mask and accompanying foreach loops will get the item price specific to the package of the server. We then store this price ID in <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #000088;">$serversToReload</span></code></span> along with the server's ID.</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span style="color: #000088;">$objectMask</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> SoftLayer_ObjectMask<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$objectMask</span><span style="color: #339933;">-></span><span style="color: #004000;">billingItem</span><span style="color: #339933;">-></span><span style="color: #004000;">package</span><span style="color: #339933;">-></span><span style="color: #004000;">items</span><span style="color: #339933;">-></span><span style="color: #004000;">prices</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$hardwareClient</span><span style="color: #339933;">-></span><span style="color: #004000;">setObjectMask</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$objectMask</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #b1b100;">foreach</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$ipsToReload</span> <span style="color: #b1b100;">as</span> <span style="color: #000088;">$key</span> <span style="color: #339933;">=></span> <span style="color: #000088;">$ipToReload</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000088;">$server</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$hardwareClient</span><span style="color: #339933;">-></span><span style="color: #004000;">findByIpaddress</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$ipToReload</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$serversToReload</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$key</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'id'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$server</span><span style="color: #339933;">-></span><span style="color: #004000;">id</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">foreach</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$server</span><span style="color: #339933;">-></span><span style="color: #004000;">billingItem</span><span style="color: #339933;">-></span><span style="color: #004000;">package</span><span style="color: #339933;">-></span><span style="color: #004000;">items</span> <span style="color: #b1b100;">as</span> <span style="color: #000088;">$item</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$item</span><span style="color: #339933;">-></span><span style="color: #004000;">description</span> <span style="color: #339933;">=</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$operatingSystem</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$serversToReload</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$key</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'priceId'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$item</span><span style="color: #339933;">-></span><span style="color: #004000;">prices</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">-></span><span style="color: #004000;">id</span><span style="color: #339933;">;</span>
            <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$serversToReload</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$key</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'priceId'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'None found'</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div>
<p>We now have everything we need to give these servers a makeover. So let's create a place to put those servers which have decided not to join the party.</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span style="color: #000088;">$failedReloads</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div>
<p>Loop through our array which is holding all of our server and price IDs. We only need to perform a reload if we have a price ID</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span style="color: #b1b100;">foreach</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$serversToReload</span> <span style="color: #b1b100;">as</span> <span style="color: #000088;">$soonToBeReloadedServer</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$soonToBeReloadedServer</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'priceId'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">!=</span> <span style="color: #0000ff;">'None found'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span></pre></div>
<p><strong>Nifty trick:</strong> <em>When needing to call a method which requires init parameters on multiple objects it is not necessary to create a SOAP client for each object. You can reuse a previously defined client by calling <span class="geshifilter"><code class="text geshifilter-text">setInitParameter</code></span> with a parameter of the new init parameter.</em></p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;">        <span style="color: #000088;">$hardwareClient</span><span style="color: #339933;">-></span><span style="color: #004000;">setInitParameter</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$soonToBeReloadedServer</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'id'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div>
<p>Time to create our configuration object, which will contain an array which defines the priceId for the new operating system. We then pass that config into <a href="/reference/services/SoftLayer_Hardware_Server/reloadOperatingSystem">SoftLayer_Hardware_Server::reloadOperatingSystem</a>. The first parameter we pass is the string 'FORCE'. This is necessary only if we wish to bypass the confirmation step which can be read about in more detail <a href="/reference/services/SoftLayer_Hardware_Server/reloadOperatingSystem"> here</a>. Also, don't forget to group the ID-less servers.</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;">        <span style="color: #000088;">$config</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> stdClass<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$config</span><span style="color: #339933;">-></span><span style="color: #004000;">itemPrices</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$config</span><span style="color: #339933;">-></span><span style="color: #004000;">itemPrices</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span>object<span style="color: #009900;">&#41;</span><a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'id'</span> <span style="color: #339933;">=></span> <span style="color: #000088;">$soonToBeReloadedServer</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'priceId'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$hardwareClient</span><span style="color: #339933;">-></span><span style="color: #004000;">reloadOperatingSystem</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'FORCE'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$config</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 
    <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$failedReloads</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$soonToBeReloadedServer</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div>
<p>You can find the full version of this script <a href="https://gist.github.com/2789898">here</a> and checkout our other projects on our <a href="http://github.com/softlayer">GitHub</a> profile.</p>
<p>Have a SLAPI problem that needs solving? <a href=mailto:sldn@softlayer.com">Let me know!</a></p>

